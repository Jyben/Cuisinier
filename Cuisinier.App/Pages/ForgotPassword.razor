@page "/forgot-password"
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]
@using Cuisinier.Core.DTOs
@using Cuisinier.App.Services
@using MudBlazor
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Mot de passe oublié</PageTitle>

<PageHeader Title="Mot de passe oublié" />

<MudContainer MaxWidth="MaxWidth.Small">
    @if (_emailSent)
    {
        <MudCard>
            <MudCardContent>
                <MudAlert Severity="Severity.Success" Class="mb-4">
                    <MudText Typo="Typo.h6" Class="mb-2">Email envoyé</MudText>
                    <MudText>Si un compte existe avec cet email, un lien de réinitialisation a été envoyé. Veuillez vérifier votre boîte mail.</MudText>
                </MudAlert>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           FullWidth="true"
                           OnClick="@(() => Navigation.NavigateTo("/login"))">
                    Retour à la connexion
                </MudButton>
            </MudCardContent>
        </MudCard>
    }
    else
    {
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.body1" Class="mb-4">
                    Entrez votre adresse email et nous vous enverrons un lien pour réinitialiser votre mot de passe.
                </MudText>
                <MudForm @ref="_form" @bind-IsValid="@success" @bind-Errors="@errors">
                    <MudTextField T="string" 
                                  Label="Email" 
                                  Variant="Variant.Outlined" 
                                  @bind-Value="_request.Email" 
                                  For="@(() => _request.Email)"
                                  Required="true"
                                  RequiredError="L'email est requis"
                                  HelperText="Nous vous enverrons un lien de réinitialisation à cette adresse" />
                </MudForm>
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           OnClick="HandleForgotPassword" 
                           Disabled="@_loading"
                           FullWidth="true">
                    @if (_loading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Envoi en cours...</MudText>
                    }
                    else
                    {
                        <MudText>Envoyer le lien de réinitialisation</MudText>
                    }
                </MudButton>
            </MudCardActions>
            <MudCardActions>
                <MudButton Variant="Variant.Text" 
                           Color="Color.Default" 
                           OnClick="@(() => Navigation.NavigateTo("/login"))"
                           FullWidth="true">
                    Retour à la connexion
                </MudButton>
            </MudCardActions>
        </MudCard>
    }
</MudContainer>

@code {
    private ForgotPasswordRequest _request = new();
    private MudForm? _form;
    private bool success;
    private string[] errors = Array.Empty<string>();
    private bool _loading = false;
    private bool _emailSent = false;

    private async Task HandleForgotPassword()
    {
        if (_form == null) return;

        await _form.Validate();
        if (!success) return;

        _loading = true;
        try
        {
            var result = await AuthService.ForgotPasswordAsync(_request);
            if (result)
            {
                _emailSent = true;
            }
            else
            {
                Snackbar.Add("Erreur lors de l'envoi de l'email de réinitialisation.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erreur : {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }
}
