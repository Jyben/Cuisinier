@page "/accept-family-invitation"
@using Cuisinier.App.Services
@using Cuisinier.App.Components
@using Cuisinier.Shared.DTOs
@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@inject IFamilyApi FamilyApi
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Accepter l'invitation famille</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudCard Elevation="3">
        <MudCardContent Class="pa-6">
            <MudStack AlignItems="AlignItems.Center" Spacing="4">
                @if (_processing)
                {
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                    <MudText Typo="Typo.h6" Align="Align.Center">Traitement en cours...</MudText>
                }
                else if (_success)
                {
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" Style="font-size: 4rem;" />
                    <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight: 600;">
                        Invitation acceptée !
                    </MudText>
                    <MudText Typo="Typo.body1" Align="Align.Center" Style="color: rgba(0,0,0,0.6);">
                        Vos comptes sont maintenant liés. Vous pouvez désormais voir et modifier les menus de votre proche.
                    </MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/menus" Style="text-transform: none;">
                        Voir les menus
                    </MudButton>
                }
                else if (!string.IsNullOrEmpty(_error))
                {
                    <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" Style="font-size: 4rem;" />
                    <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight: 600;">
                        Impossible d'accepter l'invitation
                    </MudText>
                    <MudText Typo="Typo.body1" Align="Align.Center" Style="color: rgba(0,0,0,0.6);">
                        @_error
                    </MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/settings" Style="text-transform: none;">
                        Aller aux paramètres
                    </MudButton>
                }
                else if (!_isAuthenticated)
                {
                    <MudIcon Icon="@Icons.Material.Filled.FamilyRestroom" Color="Color.Primary" Size="Size.Large" Style="font-size: 4rem;" />
                    <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight: 600;">
                        Invitation famille
                    </MudText>
                    <MudText Typo="Typo.body1" Align="Align.Center" Style="color: rgba(0,0,0,0.6);">
                        Vous devez vous connecter pour accepter cette invitation.
                    </MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RedirectToLogin" Style="text-transform: none;">
                        Se connecter
                    </MudButton>
                }
                else if (string.IsNullOrEmpty(_token))
                {
                    <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Warning" Size="Size.Large" Style="font-size: 4rem;" />
                    <MudText Typo="Typo.h5" Align="Align.Center" Style="font-weight: 600;">
                        Lien invalide
                    </MudText>
                    <MudText Typo="Typo.body1" Align="Align.Center" Style="color: rgba(0,0,0,0.6);">
                        Le lien d'invitation est invalide ou incomplet.
                    </MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/settings" Style="text-transform: none;">
                        Aller aux paramètres
                    </MudButton>
                }
            </MudStack>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    private string? _token;
    private bool _processing = false;
    private bool _success = false;
    private string? _error;
    private bool _isAuthenticated = false;

    protected override async Task OnInitializedAsync()
    {
        _token = Token;

        // Check authentication
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        if (_isAuthenticated && !string.IsNullOrEmpty(_token))
        {
            await AcceptInvitation();
        }
    }

    private async Task AcceptInvitation()
    {
        try
        {
            _processing = true;
            StateHasChanged();

            await FamilyApi.AcceptInvitationAsync(new AcceptFamilyInvitationRequest { Token = _token });
            _success = true;
        }
        catch (Refit.ApiException ex)
        {
            _error = ex.StatusCode switch
            {
                System.Net.HttpStatusCode.BadRequest => "Cette invitation n'est pas valide, a expiré, ou n'est pas destinée à votre compte.",
                System.Net.HttpStatusCode.Conflict => "Vous avez déjà un lien famille actif. Supprimez-le d'abord pour en créer un nouveau.",
                _ => $"Une erreur est survenue : {ex.Message}"
            };
        }
        catch (Exception ex)
        {
            _error = $"Une erreur est survenue : {ex.Message}";
        }
        finally
        {
            _processing = false;
        }
    }

    private void RedirectToLogin()
    {
        var returnUrl = Uri.EscapeDataString(Navigation.Uri);
        Navigation.NavigateTo($"/login?returnUrl={returnUrl}");
    }
}
