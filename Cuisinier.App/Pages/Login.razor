@page "/login"
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]
@using Cuisinier.Core.DTOs
@using Cuisinier.Core.Validators
@using Cuisinier.App.Services
@using Cuisinier.App.Components
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using Refit
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Connexion</PageTitle>

<PageHeader Title="Connexion" />

<MudContainer MaxWidth="MaxWidth.Small">
    <MudCard>
        <MudCardContent>
            <MudForm @ref="_form" @bind-IsValid="@success" @bind-Errors="@errors" Validation="@(new LoginRequestValidator())">
                <MudTextField T="string" 
                              Label="Email" 
                              Variant="Variant.Outlined" 
                              @bind-Value="_request.Email" 
                              For="@(() => _request.Email)" />
                
                <MudTextField T="string" 
                              Label="Mot de passe" 
                              Variant="Variant.Outlined" 
                              InputType="InputType.Password" 
                              @bind-Value="_request.Password" 
                              For="@(() => _request.Password)" />
            </MudForm>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       OnClick="HandleLogin" 
                       Disabled="@_loading">
                Connexion
            </MudButton>
            <MudButton Variant="Variant.Text" 
                       Color="Color.Default" 
                       OnClick="@(() => Navigation.NavigateTo("/register"))" 
                       Disabled="@_loading">
                Créer un compte
            </MudButton>
        </MudCardActions>
    </MudCard>

    @if (_showResendConfirmation)
    {
        <MudContainer Class="mt-4 text-center">
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                Votre email n'a pas été confirmé. Un email de confirmation a peut-être été envoyé.
            </MudAlert>
            <MudButton Variant="Variant.Text" 
                       Color="Color.Primary" 
                       OnClick="HandleResendConfirmation" 
                       Disabled="@_resendingConfirmation"
                       Class="mb-2">
                @if (_resendingConfirmation)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Envoi en cours...</MudText>
                }
                else
                {
                    <MudText>Renvoyer l'email de confirmation</MudText>
                }
            </MudButton>
        </MudContainer>
    }

    <MudContainer Class="mt-4 text-center">
        <MudLink Href="/forgot-password">Mot de passe oublié ?</MudLink>
    </MudContainer>
</MudContainer>

@code {
    private LoginRequest _request = new();
    private MudForm? _form;
    private bool success;
    private string[] errors = Array.Empty<string>();
    private bool _loading = false;
    private bool _showResendConfirmation = false;
    private string _userEmail = string.Empty;
    private bool _resendingConfirmation = false;

    private async Task HandleLogin()
    {
        if (_form == null) return;

        await _form.Validate();
        if (!success) return;

        _loading = true;
        try
        {
            var response = await AuthService.LoginAsync(_request);
            if (response != null)
            {
                if (response.EmailConfirmed)
                {
                    ((AuthStateProvider)AuthStateProvider).NotifyUserAuthenticationChanged();
                    
                    // Wait a bit for authentication state to update
                    await Task.Delay(100);
                    
                    // Get returnUrl from query string
                    var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
                    var queryParams = new Dictionary<string, string>();
                    if (!string.IsNullOrEmpty(uri.Query))
                    {
                        foreach (var param in uri.Query.TrimStart('?').Split('&'))
                        {
                            var parts = param.Split('=', 2);
                            if (parts.Length == 2)
                            {
                                queryParams[Uri.UnescapeDataString(parts[0])] = Uri.UnescapeDataString(parts[1]);
                            }
                        }
                    }
                    
                    var returnUrl = queryParams.TryGetValue("returnUrl", out var returnUrlValue) ? returnUrlValue : null;
                    if (!string.IsNullOrEmpty(returnUrl) && returnUrl != "/login")
                    {
                        Navigation.NavigateTo(returnUrl);
                    }
                    else
                    {
                        Navigation.NavigateTo("/");
                    }
                }
                else
                {
                    Snackbar.Add("Veuillez confirmer votre email avant de vous connecter", Severity.Warning);
                    _showResendConfirmation = true;
                    _userEmail = _request.Email;
                }
            }
            else
            {
                Snackbar.Add("Email ou mot de passe incorrect", Severity.Error);
            }
        }
        catch (ApiException apiEx) when (apiEx.StatusCode == System.Net.HttpStatusCode.BadRequest)
        {
            // Email not confirmed but password is correct
            var content = await apiEx.GetContentAsAsync<Dictionary<string, object>>();
            if (content?.ContainsKey("emailNotConfirmed") == true && content["emailNotConfirmed"]?.ToString() == "True")
            {
                Snackbar.Add("Veuillez confirmer votre email avant de vous connecter", Severity.Warning);
                _showResendConfirmation = true;
                _userEmail = content.ContainsKey("email") ? content["email"]?.ToString() ?? _request.Email : _request.Email;
            }
            else
            {
                Snackbar.Add(content?.ContainsKey("message") == true ? content["message"]?.ToString() ?? "Erreur lors de la connexion" : "Erreur lors de la connexion", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erreur lors de la connexion : {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task HandleResendConfirmation()
    {
        if (string.IsNullOrEmpty(_userEmail))
        {
            Snackbar.Add("Veuillez d'abord tenter de vous connecter", Severity.Warning);
            return;
        }

        _resendingConfirmation = true;
        try
        {
            var result = await AuthService.ResendConfirmationEmailAsync(_userEmail);
            if (result)
            {
                Snackbar.Add("Email de confirmation renvoyé avec succès. Veuillez vérifier votre boîte mail.", Severity.Success);
                _showResendConfirmation = false;
            }
            else
            {
                Snackbar.Add("Erreur lors du renvoi de l'email de confirmation.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erreur lors du renvoi de l'email : {ex.Message}", Severity.Error);
        }
        finally
        {
            _resendingConfirmation = false;
        }
    }
}