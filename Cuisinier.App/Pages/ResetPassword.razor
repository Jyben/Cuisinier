@page "/reset-password"
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]
@using Cuisinier.Core.DTOs
@using Cuisinier.Core.Validators
@using Cuisinier.App.Services
@using MudBlazor
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Réinitialisation du mot de passe</PageTitle>

<PageHeader Title="Réinitialisation du mot de passe" />

<MudContainer MaxWidth="MaxWidth.Small">
    @if (_passwordReset)
    {
        <MudCard>
            <MudCardContent>
                <MudAlert Severity="Severity.Success" Class="mb-4">
                    <MudText Typo="Typo.h6" Class="mb-2">Mot de passe réinitialisé</MudText>
                    <MudText>Votre mot de passe a été réinitialisé avec succès. Vous pouvez maintenant vous connecter.</MudText>
                </MudAlert>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           FullWidth="true"
                           OnClick="@(() => Navigation.NavigateTo("/login"))">
                    Se connecter
                </MudButton>
            </MudCardContent>
        </MudCard>
    }
    else if (_error)
    {
        <MudCard>
            <MudCardContent>
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    <MudText Typo="Typo.h6" Class="mb-2">Erreur de réinitialisation</MudText>
                    <MudText>@_errorMessage</MudText>
                </MudAlert>
                <MudButton Variant="Variant.Text" 
                           Color="Color.Default" 
                           FullWidth="true"
                           OnClick="@(() => Navigation.NavigateTo("/forgot-password"))">
                    Demander un nouveau lien
                </MudButton>
            </MudCardContent>
        </MudCard>
    }
    else
    {
        <MudCard>
            <MudCardContent>
                <MudForm @ref="_form" @bind-IsValid="@success" @bind-Errors="@errors" Validation="@(new ResetPasswordRequestValidator())">
                    <MudTextField T="string" 
                                  Label="Nouveau mot de passe" 
                                  Variant="Variant.Outlined" 
                                  InputType="InputType.Password"
                                  @bind-Value="_request.NewPassword" 
                                  For="@(() => _request.NewPassword)" />
                    
                    <MudTextField T="string" 
                                  Label="Confirmer le nouveau mot de passe" 
                                  Variant="Variant.Outlined" 
                                  InputType="InputType.Password"
                                  @bind-Value="_request.ConfirmPassword" 
                                  For="@(() => _request.ConfirmPassword)" />
                </MudForm>
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           OnClick="HandleResetPassword" 
                           Disabled="@_loading"
                           FullWidth="true">
                    @if (_loading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Réinitialisation en cours...</MudText>
                    }
                    else
                    {
                        <MudText>Réinitialiser le mot de passe</MudText>
                    }
                </MudButton>
            </MudCardActions>
            <MudCardActions>
                <MudButton Variant="Variant.Text" 
                           Color="Color.Default" 
                           OnClick="@(() => Navigation.NavigateTo("/login"))"
                           FullWidth="true">
                    Retour à la connexion
                </MudButton>
            </MudCardActions>
        </MudCard>
    }
</MudContainer>

@code {
    private ResetPasswordRequest _request = new();
    private MudForm? _form;
    private bool success;
    private string[] errors = Array.Empty<string>();
    private bool _loading = false;
    private bool _passwordReset = false;
    private bool _error = false;
    private string _errorMessage = string.Empty;

    protected override void OnInitialized()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var queryString = uri.Query.TrimStart('?');
        var queryParams = new Dictionary<string, string>();
        
        if (!string.IsNullOrEmpty(queryString))
        {
            foreach (var param in queryString.Split('&'))
            {
                var parts = param.Split('=', 2);
                if (parts.Length == 2)
                {
                    queryParams[Uri.UnescapeDataString(parts[0])] = Uri.UnescapeDataString(parts[1]);
                }
            }
        }
        
        var userId = queryParams.TryGetValue("userId", out var userIdValue) ? userIdValue : null;
        var token = queryParams.TryGetValue("token", out var tokenValue) ? tokenValue : null;

        if (string.IsNullOrEmpty(userId) || string.IsNullOrEmpty(token))
        {
            _error = true;
            _errorMessage = "Lien de réinitialisation invalide. Veuillez vérifier que vous avez utilisé le lien complet depuis l'email.";
            return;
        }

        _request.UserId = userId;
        _request.Token = token;
    }

    private async Task HandleResetPassword()
    {
        if (_form == null) return;

        await _form.Validate();
        if (!success) return;

        _loading = true;
        try
        {
            var result = await AuthService.ResetPasswordAsync(_request);
            if (result)
            {
                _passwordReset = true;
            }
            else
            {
                _error = true;
                _errorMessage = "Le lien de réinitialisation est invalide ou a expiré. Veuillez demander un nouveau lien.";
            }
        }
        catch (Exception ex)
        {
            _error = true;
            _errorMessage = $"Erreur lors de la réinitialisation : {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }
}
