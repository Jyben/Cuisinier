@inherits LayoutComponentBase
@using MudBlazor
@using Cuisinier.App.Themes
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider
@inject Cuisinier.App.Services.AuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudThemeProvider Theme="@CuisinierTheme.GetTheme()" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <MudAppBar Elevation="1" Color="Color.Default">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        <MudText Typo="Typo.h6" Style="font-weight: 700; font-size: 1.2rem;">Cuisinier</MudText>
        <MudSpacer />
        <AuthorizeView>
            <Authorized Context="authContext">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Style="margin-right: 8px;">
                    <MudText Typo="Typo.body2" Style="text-transform: none;">@GetUserDisplayName(authContext.User)</MudText>
                    <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Text" Style="min-width: auto; padding: 4px;">
                                <MudAvatar Color="Color.Primary"
                                           Size="Size.Small"
                                           Style="font-weight: 600; font-size: 0.75rem;">
                                    @GetInitials(GetUserDisplayName(authContext.User))
                                </MudAvatar>
                            </MudButton>
                        </ActivatorContent>
                        <ChildContent>
                            <div class="user-menu-header">
                                <MudAvatar Color="Color.Primary" Size="Size.Medium" Style="font-weight: 600;">
                                    @GetInitials(GetUserDisplayName(authContext.User))
                                </MudAvatar>
                                <div class="user-menu-info">
                                    <MudText Typo="Typo.body1" Style="font-weight: 600;">@GetUserDisplayName(authContext.User)</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@GetUserEmail(authContext.User)</MudText>
                                </div>
                            </div>
                            <MudDivider Class="my-1" />
                            <MudMenuItem Icon="@Icons.Material.Outlined.Settings" Href="/settings">
                                Paramètres
                            </MudMenuItem>
                            <MudDivider Class="my-1" />
                            <MudMenuItem OnClick="HandleLogout" Icon="@Icons.Material.Outlined.Logout" IconColor="Color.Error" Style="color: var(--mud-palette-error);">
                                Déconnexion
                            </MudMenuItem>
                        </ChildContent>
                    </MudMenu>
                </MudStack>
            </Authorized>
        </AuthorizeView>
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" 
               ClipMode="DrawerClipMode.Always" 
               Elevation="2" 
               Variant="@DrawerVariant.Responsive">
        <NavMenu />
    </MudDrawer>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-2 pa-sm-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    bool _drawerOpen = true;

    void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        ((Components.AuthStateProvider)AuthStateProvider).NotifyUserAuthenticationChanged();
        Navigation.NavigateTo("/login");
    }

    private string GetUserDisplayName(ClaimsPrincipal user)
    {
        return user.FindFirst("unique_name")?.Value
            ?? user.FindFirst("name")?.Value
            ?? "Utilisateur";
    }

    private string GetUserEmail(ClaimsPrincipal user)
    {
        return user.FindFirst(ClaimTypes.Email)?.Value
            ?? user.FindFirst("email")?.Value
            ?? string.Empty;
    }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "?";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();

        return name.Length >= 2 ? name[..2].ToUpper() : name.ToUpper();
    }
}

<style>
    .user-menu-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        min-width: 220px;
    }

    .user-menu-info {
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .user-menu-info .mud-typography {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
