@using Cuisinier.Core.DTOs
@using MudBlazor
@inject IFavoriteApi FavoriteApi
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_isValid" @bind-Errors="@_errors">
            <MudTextField @bind-Value="_title" 
                          Label="Nom du plat" 
                          Variant="Variant.Outlined"
                          Required="true"
                          RequiredError="Le nom du plat est requis" />
            
            <MudTextField @bind-Value="_description" 
                          Label="Description" 
                          Variant="Variant.Outlined"
                          Lines="3"
                          Class="mt-3" />
            
            <MudTextField @bind-Value="_imageUrl" 
                          Label="URL de l'image" 
                          Variant="Variant.Outlined"
                          Class="mt-3" />
            
            <MudStack Row="true" Spacing="3" Class="mt-3">
                <MudNumericField T="int" @bind-Value="_servings" 
                                      Label="Nombre de personnes" 
                                      Variant="Variant.Outlined"
                                      Min="1"
                                      Max="20" />
                
                <MudNumericField T="int?" @bind-Value="_preparationMinutes" 
                                       Label="Temps de préparation (min)" 
                                       Variant="Variant.Outlined"
                                       Min="0" />
                
                <MudNumericField T="int?" @bind-Value="_cookingMinutes" 
                                      Label="Temps de cuisson (min)" 
                                      Variant="Variant.Outlined"
                                      Min="0" />
                
                <MudNumericField T="int?" @bind-Value="_kcal" 
                                      Label="Calories (kcal)" 
                                      Variant="Variant.Outlined"
                                      Min="0" />
            </MudStack>
            
            <MudTextField @bind-Value="_completeDescription" 
                          Label="Description complète" 
                          Variant="Variant.Outlined"
                          Lines="5"
                          Class="mt-3" />
            
            <MudTextField @bind-Value="_detailedRecipe" 
                          Label="Recette détaillée (Markdown)" 
                          Variant="Variant.Outlined"
                          Lines="10"
                          Class="mt-3" />
            
            <MudText Typo="Typo.h6" Class="mt-4 mb-2">Ingrédients</MudText>
            
            @for (int i = 0; i < _ingredients.Count; i++)
            {
                var index = i;
                <MudPaper Elevation="1" Class="pa-3 mb-2">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <MudTextField @bind-Value="_ingredients[index].Name" 
                                     Label="Nom" 
                                     Variant="Variant.Outlined"
                                     Required="true"
                                     Style="flex: 1;" />
                        <MudTextField @bind-Value="_ingredients[index].Quantity" 
                                     Label="Quantité" 
                                     Variant="Variant.Outlined"
                                     Required="true"
                                     Style="flex: 1;" />
                        <MudTextField @bind-Value="_ingredients[index].Category" 
                                     Label="Catégorie" 
                                     Variant="Variant.Outlined"
                                     Style="flex: 1;" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                     Color="Color.Error" 
                                     Size="Size.Small"
                                     Variant="Variant.Text"
                                     OnClick="@(() => RemoveIngredient(index))"
                                     Disabled="@(_ingredients.Count <= 1)" />
                    </MudStack>
                </MudPaper>
            }
            
            <MudButton Variant="Variant.Text" 
                      StartIcon="@Icons.Material.Filled.Add" 
                      OnClick="AddIngredient"
                      Class="mt-2">
                Ajouter un ingrédient
            </MudButton>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Annuler</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save" Disabled="@(!_isValid || _isSaving)">Enregistrer</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance? MudDialog { get; set; }
    [Parameter] public FavoriteResponse Favorite { get; set; } = new();

    private MudForm? _form;
    private bool _isValid;
    private string[] _errors = Array.Empty<string>();
    private bool _isSaving = false;

    private string _title = string.Empty;
    private string _description = string.Empty;
    private string? _imageUrl;
    private int _servings = 1;
    private int? _preparationMinutes;
    private int? _cookingMinutes;
    private int? _kcal;
    private string? _completeDescription;
    private string? _detailedRecipe;
    private List<IngredientRequest> _ingredients = new();

    protected override void OnParametersSet()
    {
        _title = Favorite.Title;
        _description = Favorite.Description;
        _imageUrl = Favorite.ImageUrl;
        _servings = Favorite.Servings;
        _preparationMinutes = Favorite.PreparationTime?.TotalMinutes != null ? (int)Favorite.PreparationTime.Value.TotalMinutes : null;
        _cookingMinutes = Favorite.CookingTime?.TotalMinutes != null ? (int)Favorite.CookingTime.Value.TotalMinutes : null;
        _kcal = Favorite.Kcal;
        _completeDescription = Favorite.CompleteDescription;
        _detailedRecipe = Favorite.DetailedRecipe;
        _ingredients = Favorite.Ingredients.Select(i => new IngredientRequest
        {
            Name = i.Name,
            Quantity = i.Quantity,
            Category = i.Category
        }).ToList();

        if (_ingredients.Count == 0)
        {
            _ingredients.Add(new IngredientRequest());
        }
    }

    private void AddIngredient()
    {
        _ingredients.Add(new IngredientRequest());
    }

    private void RemoveIngredient(int index)
    {
        if (_ingredients.Count > 1)
        {
            _ingredients.RemoveAt(index);
        }
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private async Task Save()
    {
        if (!_isValid || _isSaving) return;

        _isSaving = true;
        try
        {
            var request = new FavoriteRequest
            {
                Title = _title,
                Description = _description,
                ImageUrl = _imageUrl,
                Servings = _servings,
                PreparationTime = _preparationMinutes.HasValue ? TimeSpan.FromMinutes(_preparationMinutes.Value) : null,
                CookingTime = _cookingMinutes.HasValue ? TimeSpan.FromMinutes(_cookingMinutes.Value) : null,
                Kcal = _kcal,
                CompleteDescription = _completeDescription,
                DetailedRecipe = _detailedRecipe,
                Ingredients = _ingredients.Where(i => !string.IsNullOrWhiteSpace(i.Name)).ToList()
            };

            await FavoriteApi.UpdateFavoriteAsync(Favorite.Id, request);
            Snackbar.Add("Plat favori modifié avec succès", Severity.Success);
            MudDialog?.Close(DialogResult.Ok(true));
        }
        catch (Refit.ApiException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Conflict)
        {
            Snackbar.Add("Un plat avec le même nom et les mêmes ingrédients existe déjà", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erreur lors de la modification : {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }
}
