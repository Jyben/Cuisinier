@using Cuisinier.Shared.DTOs
@using MudBlazor
@using Markdig
@using Refit
@using Microsoft.Extensions.Logging
@inject IDialogService DialogService
@inject IFavoriteApi FavoriteApi
@inject ISnackbar Snackbar
@inject ILogger<RecipeCard> Logger

<MudCard Elevation="2" Class="@GetCardClass()">
    @if (IsReplacing)
    {
        <div class="replacing-overlay">
            <div class="replacing-content">
                <MudProgressCircular Size="Size.Large" Indeterminate="true" Color="Color.Primary" />
                <MudText Typo="Typo.body1" Class="mt-3" Style="color: white; font-weight: 500;">
                    Remplacement en cours...
                </MudText>
            </div>
        </div>
    }
    <div class="recette-card-header">
        @if (!string.IsNullOrEmpty(Recipe.ImageUrl))
        {
            <MudImage Src="@Recipe.ImageUrl" Alt="@Recipe.Title" Height="160" ObjectFit="ObjectFit.Cover" />
        }
        <div class="header-buttons">
            @if (ShowFavoriteButton)
            {
                <MudIconButton 
                    Icon="@(_isFavorite ? Icons.Material.Filled.Favorite : Icons.Material.Outlined.FavoriteBorder)"
                    Color="@(_isFavorite ? Color.Error : Color.Default)"
                    Size="Size.Small"
                    Variant="Variant.Text"
                    OnClick="ToggleFavorite"
                    Class="favorite-button"
                    Style="@(_isFavorite ? "color: var(--mud-palette-error);" : "")" />
            }
            @if (OnToggleCooked.HasDelegate && MenuValid)
            {
                <MudIconButton 
                    Icon="@(Recipe.IsCooked ? Icons.Material.Filled.CheckCircle : Icons.Material.Outlined.CheckCircle)"
                    Color="@(Recipe.IsCooked ? Color.Success : Color.Default)"
                    Size="Size.Small"
                    Variant="Variant.Text"
                    OnClick="ToggleCooked"
                    Class="cooked-button"
                    Style="@(Recipe.IsCooked ? "color: var(--mud-palette-success);" : "")" />
            }
        </div>
    </div>
    <MudCardContent Class="pa-3">
        <MudText Typo="Typo.h6" Class="mb-1" Style="font-weight: 600;">@Recipe.Title</MudText>
        <MudText Typo="Typo.body2" Class="mb-2" Style="color: rgba(0,0,0,0.6); line-height: 1.4;">@Recipe.Description</MudText>
        
        @if (ShowDetails && !string.IsNullOrEmpty(Recipe.CompleteDescription))
        {
            <MudExpansionPanels Class="mb-2">
                <MudExpansionPanel Text="Recette complète" Icon="@Icons.Material.Filled.Receipt">
                    <MudText Typo="Typo.body2">@Recipe.CompleteDescription</MudText>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
        
        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Class="mb-2">
            <MudTooltip Text="Nombre de personnes">
                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-1" Style="color: rgba(0,0,0,0.54);" />
            </MudTooltip>
            <MudText Typo="Typo.caption" Style="color: rgba(0,0,0,0.7);">@Recipe.Servings</MudText>
            @if (Recipe.PreparationTime.HasValue)
            {
                <MudTooltip Text="Temps de préparation">
                    <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Class="ml-2 mr-1" Style="color: rgba(0,0,0,0.54);" />
                </MudTooltip>
                <MudText Typo="Typo.caption" Style="color: rgba(0,0,0,0.7);">@((int)Recipe.PreparationTime.Value.TotalMinutes)min</MudText>
            }
            @if (Recipe.CookingTime.HasValue)
            {
                <MudTooltip Text="Temps de cuisson">
                    <MudIcon Icon="@Icons.Material.Filled.Microwave" Size="Size.Small" Class="ml-2 mr-1" Style="color: rgba(0,0,0,0.54);" />
                </MudTooltip>
                <MudText Typo="Typo.caption" Style="color: rgba(0,0,0,0.7);">@((int)Recipe.CookingTime.Value.TotalMinutes)min</MudText>
            }
            @if (Recipe.Kcal.HasValue)
            {
                <MudTooltip Text="Calories">
                    <MudIcon Icon="@Icons.Material.Filled.LocalFireDepartment" Size="Size.Small" Class="ml-2 mr-1" Style="color: rgba(0,0,0,0.54);" />
                </MudTooltip>
                <MudText Typo="Typo.caption" Style="color: rgba(0,0,0,0.7);">@Recipe.Kcal.Value kcal</MudText>
            }
        </MudStack>
        
        <MudExpansionPanels>
            <MudExpansionPanel Text="Ingrédients" Icon="@Icons.Material.Filled.ListAlt">
                <div style="padding: 0; margin: 0;">
                    @foreach (var ingredient in Recipe.Ingredients)
                    {
                        <div style="padding: 2px 0; line-height: 1.2; font-size: 0.875rem;">
                            <span style="font-weight: 500;">@ingredient.Name</span>: <span style="color: rgba(0,0,0,0.7);">@ingredient.Quantity</span>
                        </div>
                    }
                </div>
            </MudExpansionPanel>
            @if (IsGenerating && MenuValid)
            {
                <MudButton 
                    Variant="Variant.Text" 
                    Size="Size.Small" 
                    Color="Color.Primary" 
                    FullWidth="true"
                    Disabled="true"
                    Class="mt-2 recette-detail-button">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Style="width: 16px; height: 16px;" />
                        <span style="opacity: 0.7;">Génération de la recette détaillée...</span>
                    </MudStack>
                </MudButton>
            }
            else if (!string.IsNullOrEmpty(Recipe.DetailedRecipe))
            {
                <MudButton 
                    Variant="Variant.Text" 
                    Size="Size.Small" 
                    Color="Color.Primary" 
                    FullWidth="true"
                    OnClick="OpenDetailedRecipe"
                    StartIcon="@Icons.Material.Filled.Receipt"
                    Class="mt-2 recette-detail-button">
                    Voir la recette détaillée
                </MudButton>
            }
        </MudExpansionPanels>
    </MudCardContent>
    @if (ShowActions)
    {
        <MudCardActions Class="pa-3 pt-0">
            <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd" Style="width: 100%;">
                @if (OnReplace.HasDelegate)
                {
                    <MudButton 
                        Variant="Variant.Outlined" 
                        Size="Size.Small" 
                        Color="Color.Primary" 
                        OnClick="() => OnReplace.InvokeAsync(Recipe.Id)"
                        StartIcon="@Icons.Material.Filled.SwapHoriz"
                        Disabled="@IsReplacing"
                        Class="action-button">
                        Remplacer
                    </MudButton>
                }
                @if (OnDelete.HasDelegate)
                {
                    <MudButton 
                        Variant="Variant.Outlined" 
                        Size="Size.Small" 
                        Color="Color.Error" 
                        OnClick="() => OnDelete.InvokeAsync(Recipe.Id)"
                        StartIcon="@Icons.Material.Filled.Delete"
                        Class="action-button">
                        Supprimer
                    </MudButton>
                }
            </MudStack>
        </MudCardActions>
    }
</MudCard>

@code {
    [Parameter] public RecipeResponse Recipe { get; set; } = new();
    [Parameter] public bool ShowDetails { get; set; } = false;
    [Parameter] public bool ShowActions { get; set; } = false;
    [Parameter] public bool ShowFavoriteButton { get; set; } = true;
    [Parameter] public bool IsGenerating { get; set; } = false;
    [Parameter] public bool IsReplacing { get; set; } = false;
    [Parameter] public bool MenuValid { get; set; } = false;
    [Parameter] public EventCallback<int> OnDelete { get; set; }
    [Parameter] public EventCallback<int> OnReplace { get; set; }
    [Parameter] public EventCallback<int> OnToggleCooked { get; set; }
    [Parameter] public bool? IsFavorite { get; set; }

    private bool _isFavorite = false;
    private bool _isLoadingFavorite = false;

    private string GetCardClass()
    {
        return Recipe.IsCooked ? "recette-card cooked" : "recette-card";
    }

    protected override async Task OnInitializedAsync()
    {
        // Only check if favorite button is shown (not during menu generation)
        if (ShowFavoriteButton)
        {
            if (IsFavorite.HasValue)
            {
                // Use the provided value from batch check
                _isFavorite = IsFavorite.Value;
            }
            else
            {
                // Fallback to individual check if not provided
                await CheckIfFavorite();
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Only check if favorite button is shown (not during menu generation)
        if (ShowFavoriteButton)
        {
            if (IsFavorite.HasValue)
            {
                // Use the provided value from batch check
                _isFavorite = IsFavorite.Value;
            }
            else
            {
                // Fallback to individual check if not provided
                await CheckIfFavorite();
            }
        }
    }

    private async Task CheckIfFavorite()
    {
        try
        {
            var checkRequest = new CheckDuplicateRequest
            {
                Title = Recipe.Title,
                Ingredients = Recipe.Ingredients.Select(i => new IngredientRequest
                {
                    Name = i.Name,
                    Quantity = i.Quantity,
                    Category = i.Category
                }).ToList()
            };

            _isFavorite = await FavoriteApi.CheckDuplicateAsync(checkRequest);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to check if recipe is favorite. Title: {Title}", Recipe.Title);
            _isFavorite = false;
        }
    }

    private async Task ToggleFavorite()
    {
        if (_isLoadingFavorite) return;

        _isLoadingFavorite = true;
        try
        {
            if (_isFavorite)
            {
                // Find and delete the favorite
                var favorites = await FavoriteApi.GetAllFavoritesAsync();
                var favorite = favorites.FirstOrDefault(f =>
                {
                    if (f.Title.Trim().ToLower() != Recipe.Title.Trim().ToLower())
                        return false;

                    if (f.Ingredients.Count != Recipe.Ingredients.Count)
                        return false;

                    var fIngredients = f.Ingredients
                        .Select(i => (Name: i.Name.Trim().ToLower(), Quantity: i.Quantity.Trim().ToLower()))
                        .OrderBy(i => i.Name)
                        .ThenBy(i => i.Quantity)
                        .ToList();

                    var rIngredients = Recipe.Ingredients
                        .Select(i => (Name: i.Name.Trim().ToLower(), Quantity: i.Quantity.Trim().ToLower()))
                        .OrderBy(i => i.Name)
                        .ThenBy(i => i.Quantity)
                        .ToList();

                    return fIngredients.SequenceEqual(rIngredients, new IngredientEqualityComparer());
                });

                if (favorite != null)
                {
                    await FavoriteApi.DeleteFavoriteAsync(favorite.Id);
                    _isFavorite = false;
                    Snackbar.Add("Plat retiré des favoris", Severity.Success);
                }
            }
            else
            {
                // Add to favorites
                var request = new FavoriteRequest
                {
                    Title = Recipe.Title,
                    Description = Recipe.Description,
                    CompleteDescription = Recipe.CompleteDescription,
                    DetailedRecipe = Recipe.DetailedRecipe,
                    ImageUrl = Recipe.ImageUrl,
                    PreparationTime = Recipe.PreparationTime,
                    CookingTime = Recipe.CookingTime,
                    Kcal = Recipe.Kcal,
                    Servings = Recipe.Servings,
                    Ingredients = Recipe.Ingredients.Select(i => new IngredientRequest
                    {
                        Name = i.Name,
                        Quantity = i.Quantity,
                        Category = i.Category
                    }).ToList()
                };

                await FavoriteApi.AddFavoriteAsync(request);
                _isFavorite = true;
                Snackbar.Add("Plat ajouté aux favoris", Severity.Success);
            }
        }
        catch (ApiException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Conflict)
        {
            Snackbar.Add("Ce plat existe déjà dans les favoris", Severity.Warning);
            _isFavorite = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erreur : {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoadingFavorite = false;
        }
    }

    private async Task ToggleCooked()
    {
        if (OnToggleCooked.HasDelegate)
        {
            await OnToggleCooked.InvokeAsync(Recipe.Id);
        }
    }

    private async Task OpenDetailedRecipe()
    {
        var parameters = new DialogParameters<RecipeDetailsDialog>
        {
            { x => x.Recipe, Recipe }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        await DialogService.ShowAsync<RecipeDetailsDialog>("Recette détaillée", parameters, options);
    }

    private class IngredientEqualityComparer : IEqualityComparer<(string Name, string Quantity)>
    {
        public bool Equals((string Name, string Quantity) x, (string Name, string Quantity) y)
        {
            return x.Name == y.Name && x.Quantity == y.Quantity;
        }

        public int GetHashCode((string Name, string Quantity) obj)
        {
            return HashCode.Combine(obj.Name, obj.Quantity);
        }
    }
}

<style>
    .recette-card {
        position: relative;
        overflow: hidden;
    }

    .recette-card-header {
        position: relative;
    }

    .header-buttons {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 10;
        display: flex;
        gap: 4px;
    }

    .favorite-button,
    .cooked-button {
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .favorite-button:hover,
    .cooked-button:hover {
        background-color: rgba(255, 255, 255, 1);
        transform: scale(1.1);
        transition: all 0.2s ease;
    }

    .action-button {
        text-transform: none;
        font-weight: 500;
        letter-spacing: 0.3px;
    }

    .recette-detail-button {
        text-transform: none;
        font-weight: 500;
        justify-content: flex-start;
        margin-top: 0.5rem;
    }

    .replacing-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        border-radius: var(--mud-default-borderradius);
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-in;
    }

    .replacing-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    /* Arrondir le bas du dernier panel dans MudExpansionPanels - cibler tous les éléments possibles */
    .recette-card .mud-expansion-panels .mud-expansion-panel:last-child,
    .recette-card .mud-expansion-panels .mud-expansion-panel:last-child > *,
    .recette-card .mud-expansion-panels .mud-expansion-panel:last-child .mud-expansion-panel-header,
    .recette-card .mud-expansion-panels .mud-expansion-panel:last-child .mud-expansion-panel-content,
    .recette-card .mud-expansion-panels .mud-expansion-panel:last-child .mud-expansion-panel-header > * {
        border-bottom-left-radius: var(--mud-default-borderradius, 4px) !important;
        border-bottom-right-radius: var(--mud-default-borderradius, 4px) !important;
    }

    /* Style pour les cartes cuisinées - visuellement désactivées */
    .recette-card.cooked {
        opacity: 0.6;
        filter: grayscale(0.3);
        position: relative;
    }

    .recette-card.cooked::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(76, 175, 80, 0.1) 100%);
        pointer-events: none;
        z-index: 1;
        border-radius: var(--mud-default-borderradius);
    }

    /* S'assurer que les boutons restent interactifs et à leur place */
    .recette-card.cooked .header-buttons {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 10;
    }

    .recette-card.cooked .mud-card-actions,
    .recette-card.cooked .mud-button,
    .recette-card.cooked .mud-icon-button {
        position: relative;
        z-index: 2;
    }
</style>

